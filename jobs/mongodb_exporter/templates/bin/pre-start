#!/usr/bin/env bash
set -eu

JOB_DIR=/var/vcap/jobs/mongodb_exporter

# Add all packages' /bin & /sbin into $PATH
for package_bin_dir in $(ls -d /var/vcap/packages/*/bin)
do
  export PATH=${package_bin_dir}:${PATH}
done

LD_LIBRARY_PATH=${LD_LIBRARY_PATH:-''} # default to empty
for package_lib_dir in $(ls -d /var/vcap/packages/*/lib /var/vcap/packages/*/lib64)
do
  LD_LIBRARY_PATH=${package_lib_dir}:${LD_LIBRARY_PATH}
done
export LD_LIBRARY_PATH

<%- if_p('mongodb.uri') do |uri| %>
PORT=$(echo <%= uri %>|sed -e "s/^.*@[^:]*:\([0-9]*\).*/\1/")
<%- end %>

<%- if p('mongodb.tls') == true -%>
exec chpst -u vcap:vcap env HOME=/home/vcap mongo --ssl \
  --sslCAFile <%= p('mongodb.tls_ca') %> \
  --quiet \
  "mongodb://<%= p('mongodb.root.username') %>:<%= p('mongodb.root.password') %>@127.0.0.1:${PORT}/?authSource=admin&ssl=true" \
  < $JOB_DIR/js/create_clustermonitor_user.js
<%- else -%>
exec chpst -u vcap:vcap env HOME=/home/vcap mongo \
  --quiet \
  "mongodb://<%= p('mongodb.root.username') %>:<%= p('mongodb.root.password') %>@127.0.0.1:${PORT}/?authSource=admin" \
  < $JOB_DIR/js/create_clustermonitor_user.js
<%- end -%>  

#!/usr/bin/env bash
set -eu

JOB_DIR=/var/vcap/jobs/mongodb_exporter

# Add all packages' /bin & /sbin into $PATH
for package_bin_dir in $(ls -d /var/vcap/packages/*/bin)
do
  export PATH=${package_bin_dir}:${PATH}
done

LD_LIBRARY_PATH=${LD_LIBRARY_PATH:-''} # default to empty
for package_lib_dir in $(ls -d /var/vcap/packages/*/lib /var/vcap/packages/*/lib64)
do
  LD_LIBRARY_PATH=${package_lib_dir}:${LD_LIBRARY_PATH}
done
export LD_LIBRARY_PATH

<%- if_p(mongodb.tls) %>
exec chpst -u vcap:vcap env HOME=/home/vcap mongo --ssl \
  --sslCAFile <%= %> \
  --quiet \
  "mongodb://<%= 'root.username' %>:<%= 'root.password' %>@127.0.0.1/?authenticationDatabase=admin&ssl=true" \
  < $JOB_DIR/js/create_clustermonitor_user
<%- else %>
exec chpst -u vcap:vcap env HOME=/home/vcap mongo \
  --quiet \
  "mongodb://<%= 'root.username' %>:<%= 'root.password' %>@127.0.0.1/?authenticationDatabase=admin&ssl=true" \
  < $JOB_DIR/js/create_clustermonitor_user
<%- end %>  
